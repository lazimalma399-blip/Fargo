import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry
import json
import time

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API ---
# –í —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ —ç—Ç–æ –±—É–¥–µ—Ç endpoint –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É (Login)
AUTHENA_LOGIN_URL = "https://mock-authena-api.com/v1/auth/login" 
MAX_RETRIES = 3 
RETRY_BACKOFF = 1.0 

# --- 1. –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–∞—è HTTP-–°–µ—Å—Å–∏—è (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞) ---

def create_resilient_session():
    """–°–æ–∑–¥–∞–µ—Ç requests.Session —Å –ª–æ–≥–∏–∫–æ–π –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏."""
    retry_strategy = Retry(
        total=MAX_RETRIES,
        backoff_factor=RETRY_BACKOFF,
        status_forcelist=[500, 502, 503, 504],
    )
    adapter = HTTPAdapter(max_retries=retry_strategy)
    session = requests.Session()
    session.mount("http://", adapter)
    session.mount("https://", adapter)
    return session

# --- 2. –§—É–Ω–∫—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ---

def authenticate_user(session, credentials, api_key):
    """
    –ò–º–∏—Ç–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞.
    """
    
    # –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞
    login_payload = {
        "email": credentials["email"],
        "password": credentials["password"]
    }
    
    # –ó–∞–≥–æ–ª–æ–≤–∫–∏, –≤–∫–ª—é—á–∞—è –∫–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞
    headers = {
        "Content-Type": "application/json",
        "X-API-Key": api_key, 
        "Accept": "application/json"
    }

    print(f"\n-> üîë –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—Ö–æ–¥ –¥–ª—è {credentials['email']}...")
    
    try:
        # –í—ã–ø–æ–ª–Ω—è–µ–º POST-–∑–∞–ø—Ä–æ—Å
        response = session.post(
            AUTHENA_LOGIN_URL,
            json=login_payload,
            headers=headers,
            timeout=15
        )
        
        # –í—ã–∑–æ–≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ 4xx/5xx
        response.raise_for_status()
        
        # –û–∂–∏–¥–∞–µ–º 200 OK –∏–ª–∏ 201 Created
        if response.status_code in [200, 201]:
            response_data = response.json()
            
            # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–æ–ª–µ 'accessToken' –∏–ª–∏ 'token'
            access_token = response_data.get('accessToken')
            
            if access_token:
                print("‚úÖ –£–°–ü–ï–•: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω.")
                print(f"   –ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ (JWT): {access_token[:20]}...")
                # 
                return access_token, response_data
            else:
                print("‚ùå –û–®–ò–ë–ö–ê: –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª —É—Å–ø–µ—à–Ω–æ, –Ω–æ –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–æ–∫–µ–Ω.")
                return None, response_data

    except requests.exceptions.HTTPError as e:
        error_code = e.response.status_code
        
        if error_code == 401:
            print(f"‚ùå –û–®–ò–ë–ö–ê 401: –ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø. –ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å.")
        elif error_code == 403:
             print(f"‚ùå –û–®–ò–ë–ö–ê 403: –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω).")
        else:
            print(f"‚ùå HTTP –û—à–∏–±–∫–∞ (–ö–æ–¥ {error_code}): {e.response.text}")
        
    except requests.exceptions.RequestException as e:
        print(f"‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç: {e}")
        
    return None, None

# --- –ì–ª–∞–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã ---

if __name__ == "__main__":
    
    # --- 1. –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ---
    
    # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    LOGIN_CREDENTIALS = {
        "email": "test.user_1684567890@example.com", # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π email
        "password": "SecurePassword123!" 
    }
    
    MOCK_API_KEY = "Your-Authena-Public-Key-12345"

    print("--- üîë –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò (LOGIN) ---")
    
    # 2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    session = create_resilient_session()

    # 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    token, response_data = authenticate_user(session, LOGIN_CREDENTIALS, MOCK_API_KEY)
    
    print("-" * 60)
    
    if token:
        print("‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!")
        
        # --- 4. –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ ---
        print("\n--- –ò–º–∏—Ç–∞—Ü–∏—è –ó–ê–©–ò–©–ï–ù–ù–û–ì–û –ó–ê–ü–†–û–°–ê (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞) ---")
        
        PROTECTED_ENDPOINT = "https://mock-authena-api.com/v1/user/profile"
        
        protected_headers = {
            "Authorization": f"Bearer {token}", # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è JWT
            "X-API-Key": MOCK_API_KEY 
        }
        
        print(f"-> üõ°Ô∏è –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ GET-–∑–∞–ø—Ä–æ—Å–∞ —Å —Ç–æ–∫–µ–Ω–æ–º...")
        
        try:
            # –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ GET-–∑–∞–ø—Ä–æ—Å–∞
            protected_response = session.get(PROTECTED_ENDPOINT, headers=protected_headers, timeout=10)
            protected_response.raise_for_status()
            
            print(f"‚úÖ –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω (–ö–æ–¥ {protected_response.status_code}).")
            # print(f"   –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è: {protected_response.json()}")
            
        except requests.exceptions.RequestException as e:
            print(f"‚ùå –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è: {e}")
            
    else:
        print("–í—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞.")

    session.close()
